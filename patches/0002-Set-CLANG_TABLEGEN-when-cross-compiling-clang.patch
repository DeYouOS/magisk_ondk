From b5a02a88ad628b1cfa019cc8efc1ce98d7ad5b49 Mon Sep 17 00:00:00 2001
From: topjohnwu <topjohnwu@google.com>
Date: Tue, 21 Jun 2022 01:58:37 -0700
Subject: [PATCH 2/4] Set CLANG_TABLEGEN when cross compiling clang

When cross compiling rustc with `llvm.clang = true`, CLANG_TABLEGEN
has to be set to the host clang-tblgen executable to build clang.
---
 src/bootstrap/native.rs | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/src/bootstrap/native.rs b/src/bootstrap/native.rs
index ece02499d24..dfbf16ef4b2 100644
--- a/src/bootstrap/native.rs
+++ b/src/bootstrap/native.rs
@@ -417,11 +417,17 @@ fn run(self, builder: &Builder<'_>) -> PathBuf {
             //        actually exists most of the time in normal installs of LLVM.
             let host_bin = builder.llvm_out(builder.config.build).join("bin");
             cfg.define("LLVM_TABLEGEN", host_bin.join("llvm-tblgen").with_extension(EXE_EXTENSION));
-            cfg.define("LLVM_NM", host_bin.join("llvm-nm").with_extension(EXE_EXTENSION));
             cfg.define(
                 "LLVM_CONFIG_PATH",
                 host_bin.join("llvm-config").with_extension(EXE_EXTENSION),
             );
+            if builder.config.llvm_clang {
+                let build_bin = builder.llvm_out(builder.config.build).join("build").join("bin");
+                cfg.define(
+                    "CLANG_TABLEGEN",
+                    build_bin.join("clang-tblgen").with_extension(EXE_EXTENSION),
+                );
+            }
         }
 
         if let Some(ref suffix) = builder.config.llvm_version_suffix {
-- 
2.36.1

